<!DOCTYPE html>
{% load static %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <link rel="icon" type="image/icon" href="https://grupohitec.com/wp-content/uploads/2021/09/favicon.ico"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">   
    <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cotizadorhitecpretest.z13.web.core.windows.net/edicionCliente.css">   
    
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top bg-black" style="padding: 0px;">
        <div class="container-fluid">
          <a class="navbar-brand" style="padding: 0px;" href="/"><img src="https://cotizadorhitecpretest.z13.web.core.windows.net/logoCDR.png" height="70px"><!--<img src="https://grupohitec.com/wp-content/uploads/2021/06/GRUPO-HITEC.svg" height="50px">--></a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
              <li class="nav-item">
                <a class="nav-link active" style="padding-top: 0px; padding-bottom: 0px;" aria-current="page" href="#">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" style="padding-top: 0px; padding-bottom: 0px;" href="#">Clientes</a>
              </li>
            </ul>
            <div class="btn-group ml-auto dropleft">
            </div>
          </div>
        </div>
      </nav>
      <div class="container py-4">
        {% block body %}
        {% endblock %}
      </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1/dist/es-module-shims.min.js" crossorigin="anonymous"></script>
    <script type="importmap">
    {
      "imports": {
        "@popperjs/core": "https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/esm/popper.min.js",
        "bootstrap": "https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.esm.min.js"
      }
    }
    </script>
    <script type="module">
      import * as bootstrap from 'bootstrap'

      new bootstrap.Popover(document.getElementById('popoverButton'))
      
    </script>
    <script>
      $(document).ready(function () {
            $('#clientes-table').DataTable();
        });
        
        let rutaVista = "../../../";
        let vista = document.getElementById('vista').value;
        let idRegistro = document.getElementById('idRegistro').value;
        let idPais = document.getElementById('idPais').value;
        let pais = document.getElementById('Pais').value;
        let idRegion = document.getElementById('idRegion').value;
        let region = document.getElementById('Region').value;
        let idCodDomFis = document.getElementById('idCodDomFis').value;
        let idCodPos = document.getElementById('idCodPos').value;
        let iniDistrito = document.getElementById('iniDistrito').value;
        let coddomfis = document.getElementById('CodDomFis').value;

window.addEventListener("load", async () => {
    await cargaInicial();
});

const cargaInicial = async() => {
    await ListarPaises();
    await ListarEstados(idPais, true);
    console.log(idRegistro);
    if(idPais=="MX") {
        await ListarCodPos(idRegion, true);
        if(idRegistro > 0) {
            await ListarColonias(idCodPos, true);   }
    }

    PaisRegion.addEventListener("change", (event) => {

        let tagNac = document.getElementById('dataNac');
        let tagInt = document.getElementById('dataInt');
        var tagUS = false
        if(vista=="Cliente") {
            tagUS = document.getElementById('dataUS');  }

        if(event.target.value != "MX") {
            tagNac.setAttribute("hidden", true);
            tagInt.removeAttribute("hidden");
            if(vista=="Cliente") {
                if(event.target.value == "US") {
                    tagUS.removeAttribute("hidden"); }                
                else {
                    tagUS.setAttribute("hidden", true); }
            }
        }
        else {
            tagInt.setAttribute("hidden", true);
            tagNac.removeAttribute("hidden");
        }
        ListarEstados(event.target.value, false);   
    });

    Estado.addEventListener("change", (event) => {
        ListarCodPos(event.target.value);
        clearColonias();
    });

    CodigoPostal.addEventListener("change", (event) => {
        ListarColonias(event.target.value);
    });
};

const ListarPaises = async() => {
    try {
        const response = await fetch(`${rutaVista}paises/`);
        const data = await response.json();
        console.log(data);
        if(data.message == "Success") {
            opciones = `<option value='${idPais}'>${pais}</option>`;
            data.paises.forEach((pais)=> {
                opciones += `<option value='${pais.CodeId}'>${pais.Descrip}</option>`;
            });
            PaisRegion.innerHTML = opciones;
        }
        else {
            alert("Países no encontrados");
        }

    } catch (error) {
        console.log(error);
    }
};

const ListarEstados = async(idPais, inival) => {
    let opciones = ``;
    try {
        const response = await fetch(`${rutaVista}estados/${idPais}`);
        const data = await response.json();
        console.log(data);
        if(data.message == "Success") {            
            if (inival) {
                opciones = `<option value='${idRegion}'>${region}</option>`;
            } else {
                if(idPais=="MX") {
                    opciones = `<option value='CMX'>Ciudad de México</option>`;
                    ListarCodPos('CMX');
                }    
            }

            estados = data.estados;
            estados.forEach((estado)=> {
                opciones += `<option value='${estado.CodeId}'>${estado.Descrip}</option>`;
            });
            Estado.innerHTML = opciones;

            if(vista=='Cliente') {
                if(idPais=="US") {
                    CodigoDomFiscal.innerHTML = opciones;   }
                else {
                    opciones = ``;
                    CodigoDomFiscal.innerHTML = opciones;   }
            }
        }
        else {
            Estado.innerHTML = opciones;
            alert("Estados no encontrados");
        }
    } catch (error) {
        console.log(error);
    }
};

const ListarCodPos = async(idRegion, inival) => {
    try {
        const response = await fetch(`${rutaVista}codigos/${idRegion}`);
        const data = await response.json();
        console.log(data);
        if(data.message == "Success") {
            let opciones = ``;
            if(inival) {
                if( idCodPos != "")
                opciones = `<option value='${idCodPos}'>${idCodPos}</option>`;            
            }
            codigos = data.codigos;
            codigos.forEach((codigo)=> {
                opciones += `<option value='${codigo.D_codigo}'>${codigo.D_codigo}</option>`;
            });
            CodigoPostal.innerHTML = opciones;
        }
        else {
            if(!inival)
                alert("Códigos Postales no encontrados");
        }

    } catch (error) {
        console.log(error); }
};

const ListarColonias = async(CodPos, inival) => {
    try {
        const response = await fetch(`${rutaVista}colonias/${CodPos}`);
        const data = await response.json();
        console.log(data);
        var counter=0;
        if(data.message == "Success") {
            let opciones = ``;
            if (inival) {
                if( iniDistrito != "")
                opciones = `<option value='${iniDistrito}'>${iniDistrito}</option>`;
            }
            colonias = data.colonias;
            colonias.forEach((colonia)=> {
                if(counter==0)
                    mnpio = colonia.D_mnpio;
                opciones += `<option value='${colonia.D_asenta}'>${colonia.D_asenta}</option>`;
            });
            Distrito.innerHTML = opciones;
            getCiudad(mnpio);
        }
        else {
            alert("Colonias no encontrados");
        }

    } catch (error) {
        console.log(error);
    }
};

const clearColonias = async() => {
    let opciones = ``;
    Distrito.innerHTML = opciones;
    getCiudad("")
};

const clearInternacional = async() => {
    $("#IntCodigoPostal").val("");
    $("#IntCiudad").val("");
    $("#IntDistrito").val("");
};

const clearNacional = async() => {
    let opciones = ``;
    CodigoPostal.innerHTML = opciones;
    Distrito.innerHTML = opciones;
    $("#Ciudad").val("");
};

const getCiudad = async(mnpio) => {
    $("#Ciudad").val(mnpio);
};

</script>
</body>
</html>